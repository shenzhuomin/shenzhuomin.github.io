<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>中国研究生人工智能创新大赛参赛统计</title>
        <script src="./js/xlsx.full.min.js"></script>
        <script src="./js/query.js"></script>
        <link rel="stylesheet" href="./css/style.css">
    </head>
    <body>
        <div id="tips">
            <input type="file" onchange="importf(this)" />
            <input type="file" onchange="importf2(this)" />
            <button onclick="calculate()">生成简报</button>
        </div>

        <!-- 显示简报 -->
        <div id="main">
            <div class="title">
                <h1>参赛队伍统计简报</h1>
                <p id="date"></p>
            </div>
            <div class="part2">
                <p id="summary"></p>
            </div>
            <div>
                <h2>队伍提交情况</h2>
                <div id="table"></div>
            </div>
        </div>

        <script>
            var excelData = null //Excel数据
            var submitData = null //提交完成的数据
            /*
            FileReader共有4种读取方法：
            1.readAsArrayBuffer(file)：将文件读取为ArrayBuffer。
            2.readAsBinaryString(file)：将文件读取为二进制字符串
            3.readAsDataURL(file)：将文件读取为Data URL
            4.readAsText(file, [encoding])：将文件读取为文本，encoding缺省值为'UTF-8'
                         */
            var wb;//读取完成的数据
            var rABS = false; //是否将文件读取为二进制字符串

            function importf(obj) {//导入
                if(!obj.files) {
                    return;
                }
                var f = obj.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = e.target.result;
                    if(rABS) {
                        wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                            type: 'base64'
                        });
                    } else {
                        wb = XLSX.read(data, {
                            type: 'binary'
                        });
                    }
                    //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                    //wb.Sheets[Sheet名]获取第一个Sheet的数据
                    // document.getElementById("demo").innerHTML= JSON.stringify(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));

                    excelData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
                };
                if(rABS) {
                    reader.readAsArrayBuffer(f);
                } else {
                    reader.readAsBinaryString(f);
                }
            }

            function importf2(obj) {//导入
                if(!obj.files) {
                    return;
                }
                var f = obj.files[0];
                var reader = new FileReader();
                reader.onload = function(e) {
                    var data = e.target.result;
                    if(rABS) {
                        wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                            type: 'base64'
                        });
                    } else {
                        wb = XLSX.read(data, {
                            type: 'binary'
                        });
                    }
                    //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                    //wb.Sheets[Sheet名]获取第一个Sheet的数据
                    // document.getElementById("demo").innerHTML= JSON.stringify(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));

                    submitData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]])
                };
                if(rABS) {
                    reader.readAsArrayBuffer(f);
                } else {
                    reader.readAsBinaryString(f);
                }
            }

            function fixdata(data) { //文件流转BinaryString
                var o = "",
                    l = 0,
                    w = 10240;
                for(; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
                o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
                return o;
            }

            function calculate() {
                if (excelData === null || submitData === null) {
                    alert("请选择文件！")
                    return
                }
                var exportData = []
                // 计算1的数据
                var query = new Query(excelData)
                var teamTotal = query.group('队伍名称').count() //队伍总数

                query.reset()
                var schoolTotal = query.where('用户类型','=','队长').group('学校名称').count()

                query.reset()
                var data = query.where('用户类型','=','队长').group('学校名称').find()
                for (let item of data) {
                    // console.log(item)
                    var temp = {}
                    temp.name = item._id
                    temp.total = item.count
                    temp.submit = 0
                    exportData.push(temp)
                }

                // 计算2的数据
                var query = new Query(submitData)
                var submitTotal = query.group('队伍名称').count() //提交总数

                query.reset()
                var data = query.where('用户类型','=','队长').group('学校名称').find()
                // console.log(data)
                for (let item of data) {
                    let name = item._id
                    for(let item2 of exportData) {
                        if(name===item2.name) {
                            item2.submit = item.count
                            break
                        }
                    }
                }

                // 添加提交率
                for (let item of exportData) {
                    item.submitRate = Math.round((item.submit/item.total)*100)
                }

                // 排序
                query = new Query(exportData)
                exportData = query.sort('submitRate','asc').sort('total','desc').find()

                // 添加%
                for (let item of exportData) {
                    item.submitRate += '%'
                }

                // 显示时间
                var today = new Date()
                var year = today.getFullYear()
                var month = today.getMonth()+1
                var day = today.getDate()
                var hour = today.getHours()
                today = year + '/' + month + '/' + day
                document.getElementById("date").innerHTML = today

                // 显示summary
                var summary = "截至"+month+"月"+day+"日"+hour+"时：共"+teamTotal+"个队伍报名，提交"+submitTotal+"个作品，提交率为"+Math.round((submitTotal/teamTotal)*100)+"%。"
                document.getElementById("summary").innerHTML = summary
                
                // 显示表格
                var tableString = '<table><thead><tr><th>学校</th><th>参赛队伍总数</th><th>提交作品数</th><th>提交率</th></tr></thead><tbody>'
                for (let item of exportData) {
                    tableString += '<tr><td>'+item.name+'</td><td>'+item.total+'</td><td>'+item.submit+'</td><td>'+item.submitRate+'</td></tr>'
                }
                tableString += '</tbody></table>'
                document.getElementById("table").innerHTML = tableString

                document.getElementById("main").style.display = "block"
                document.getElementById("tips").style.display = "none"
                document.title = "中国研究生人工智能创新大赛参赛统计" + month + day;
            }
        </script>
    </body>
</html> 